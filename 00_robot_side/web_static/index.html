<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Farm Robot Control</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --accent: #00d4ff;
    --accent-dim: #0099bb;
    --bg: #0a0e14;
    --panel: #111820;
    --border: #1e2d3d;
    --text: #c8d8e8;
    --dim: #5a7080;
    --green: #00ff88;
    --red: #ff4060;
    --warn: #ffaa00;
  }

  html, body {
    width: 100%; height: 100dvh;
    background: var(--bg);
    color: var(--text);
    font-family: 'Courier New', Courier, monospace;
    font-size: 13px;
    overflow: hidden;
    touch-action: none;
    user-select: none;
    -webkit-user-select: none;
  }

  /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
  #app {
    display: flex; flex-direction: column;
    height: 100dvh; gap: 0;
  }

  /* Title bar */
  #titlebar {
    display: flex; align-items: center; justify-content: space-between;
    padding: 6px 12px;
    background: var(--panel);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  #titlebar .title { color: var(--accent); font-size: 14px; font-weight: bold; letter-spacing: 2px; }
  #status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: var(--dim); margin-right: 6px; }
  #status-dot.online { background: var(--green); box-shadow: 0 0 6px var(--green); }
  #status-dot.offline { background: var(--red); }
  #status-text { font-size: 11px; color: var(--dim); }

  /* HUD panels row */
  #hud-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1px;
    flex-shrink: 0;
    background: var(--border);
    border-bottom: 1px solid var(--border);
  }

  .hud-panel {
    background: var(--panel);
    padding: 8px 10px;
    display: flex; flex-direction: column; gap: 4px;
  }
  .hud-panel-title {
    color: var(--accent); font-size: 10px; letter-spacing: 1.5px;
    text-transform: uppercase; margin-bottom: 2px;
    border-bottom: 1px solid var(--border); padding-bottom: 3px;
  }
  .hud-value { display: flex; justify-content: space-between; align-items: center; }
  .hud-label { color: var(--dim); font-size: 11px; }
  .hud-num { color: var(--text); font-size: 12px; min-width: 80px; text-align: right; }
  .hud-num.accent { color: var(--accent); }

  /* Compass panel */
  #compass-panel {
    background: var(--panel);
    padding: 8px 10px;
    display: flex; flex-direction: column; gap: 4px;
    align-items: center;
  }
  #compass-panel .hud-panel-title { align-self: stretch; }
  #compass-svg-wrap {
    display: flex; flex-direction: column; align-items: center; gap: 2px;
    flex: 1;
  }
  #compass-svg { width: 80px; height: 80px; }
  #compass-bearing { color: var(--accent); font-size: 18px; font-weight: bold; }
  #compass-cardinal { color: var(--text); font-size: 12px; }
  #compass-accuracy { font-size: 10px; letter-spacing: 0.5px; }
  #compass-accuracy.acc-0 { color: var(--red); }
  #compass-accuracy.acc-1 { color: var(--warn); }
  #compass-accuracy.acc-2 { color: var(--green); }
  #compass-accuracy.acc-3 { color: var(--green); text-shadow: 0 0 4px var(--green); }

  /* Joystick data panel */
  #joy-data-panel {
    background: var(--panel);
    padding: 8px 10px;
    display: flex; flex-direction: column; gap: 4px;
  }

  /* Bottom: joystick zone */
  #joystick-zone {
    flex: 1;
    display: flex; align-items: center; justify-content: center;
    background: var(--bg);
    position: relative;
    min-height: 160px;
  }

  #joystick-hint {
    position: absolute;
    color: var(--dim); font-size: 11px;
    pointer-events: none;
    letter-spacing: 1px;
  }

  /* nipplejs overrides */
  .nipple .front { background: var(--accent) !important; }
  .nipple .back  { background: rgba(0,212,255,0.15) !important; border: 2px solid var(--accent-dim) !important; }

  /* Warning banner */
  #warn-banner {
    display: none; position: absolute; top: 0; left: 0; right: 0;
    background: var(--red); color: #fff;
    text-align: center; padding: 4px; font-size: 12px; z-index: 100;
  }
  #warn-banner.visible { display: block; }

  /* Separator bar */
  .sep { width: 100%; height: 1px; background: var(--border); flex-shrink: 0; }

  /* State toggle button */
  #state-btn {
    width: 100%;
    padding: 10px 12px;
    border: none; outline: none;
    font-family: 'Courier New', Courier, monospace;
    font-size: 13px; font-weight: bold; letter-spacing: 2px;
    cursor: pointer; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center; gap: 10px;
    transition: background 0.2s;
  }
  #state-btn.state-ready  { background: #1a0a0a; color: var(--red);   border-bottom: 2px solid var(--red); }
  #state-btn.state-active { background: #0a1a0e; color: var(--green); border-bottom: 2px solid var(--green); box-shadow: 0 0 8px rgba(0,255,136,0.2); }
  #state-btn:disabled     { opacity: 0.4; cursor: not-allowed; }

  /* RTK panel */
  #rtk-panel {
    background: var(--panel);
    padding: 8px 10px;
    flex-shrink: 0;
    border-bottom: 1px solid var(--border);
  }
  #rtk-header {
    display: flex; align-items: center; gap: 8px;
    margin-bottom: 6px;
    border-bottom: 1px solid var(--border); padding-bottom: 4px;
  }
  #rtk-title { color: var(--accent); font-size: 10px; letter-spacing: 1.5px; text-transform: uppercase; }
  #rtk-fix-badge {
    font-size: 10px; font-weight: bold; letter-spacing: 1px;
    padding: 1px 6px; border-radius: 3px;
    background: #2a0a0a; color: var(--red); border: 1px solid var(--red);
  }
  #rtk-fix-badge.fix-gps  { background: #2a1a00; color: var(--warn); border-color: var(--warn); }
  #rtk-fix-badge.fix-rtk  { background: #0a1a0e; color: var(--green); border-color: var(--green); box-shadow: 0 0 6px rgba(0,255,136,0.3); }
  #rtk-live-dot {
    display: inline-block; width: 7px; height: 7px; border-radius: 50%;
    background: var(--dim); margin-left: auto;
  }
  #rtk-live-dot.live { background: var(--green); box-shadow: 0 0 5px var(--green); }
  #rtk-grid {
    display: grid; grid-template-columns: 1fr 1fr 1fr;
    gap: 3px 8px;
  }
  .rtk-cell { display: flex; flex-direction: column; }
  .rtk-cell-label { color: var(--dim); font-size: 9px; letter-spacing: 0.5px; }
  .rtk-cell-val   { color: var(--text); font-size: 11px; }
  .rtk-cell-val.accent { color: var(--accent); }

  /* Record button */
  #rec-bar {
    display: flex; align-items: center; gap: 8px;
    padding: 6px 10px;
    background: var(--panel);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  #rec-btn {
    padding: 5px 14px;
    border: none; outline: none;
    font-family: 'Courier New', Courier, monospace;
    font-size: 12px; font-weight: bold; letter-spacing: 1.5px;
    cursor: pointer; border-radius: 3px;
    transition: background 0.2s;
  }
  #rec-btn.rec-idle    { background: #1e2d3d; color: var(--dim);   border: 1px solid var(--border); }
  #rec-btn.rec-active  { background: #2a0808; color: var(--red);   border: 1px solid var(--red); box-shadow: 0 0 6px rgba(255,64,96,0.3); }
  #rec-filename { color: var(--dim); font-size: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }

  /* Speed slider */
  #speed-bar {
    display: flex; align-items: center; gap: 8px;
    padding: 6px 12px;
    background: var(--panel);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    font-size: 12px; color: var(--dim);
    font-family: 'Courier New', Courier, monospace;
  }
  #speed-label { letter-spacing: 1px; white-space: nowrap; }
  #speed-slider {
    flex: 1;
    accent-color: var(--accent);
  }
  #speed-value {
    min-width: 40px; text-align: right;
    color: var(--accent); font-weight: bold;
  }

  /* ‚îÄ‚îÄ Nav panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  #nav-panel {
    display: flex; align-items: center; gap: 6px;
    padding: 6px 10px;
    background: var(--panel);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    flex-wrap: wrap;
  }
  #nav-title { color: var(--accent); font-size: 10px; letter-spacing: 1.5px; text-transform: uppercase; white-space: nowrap; }
  #nav-upload-btn {
    padding: 4px 10px;
    border: 1px solid var(--border); border-radius: 3px;
    background: #1e2d3d; color: var(--dim);
    font-family: 'Courier New', Courier, monospace;
    font-size: 11px; cursor: pointer;
    white-space: nowrap;
  }
  #nav-upload-btn:hover { border-color: var(--accent); color: var(--accent); }
  #nav-wp-count { color: var(--dim); font-size: 11px; white-space: nowrap; min-width: 50px; }

  .nav-mode-btn {
    padding: 4px 8px;
    border: 1px solid var(--border); border-radius: 3px;
    background: #1e2d3d; color: var(--dim);
    font-family: 'Courier New', Courier, monospace;
    font-size: 10px; cursor: pointer; letter-spacing: 0.5px;
    white-space: nowrap;
  }
  .nav-mode-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(0,212,255,0.08); }

  #nav-auto-btn {
    padding: 5px 14px;
    border: none; outline: none;
    font-family: 'Courier New', Courier, monospace;
    font-size: 12px; font-weight: bold; letter-spacing: 1.5px;
    cursor: pointer; border-radius: 3px;
    margin-left: auto;
    white-space: nowrap;
  }
  #nav-auto-btn.nav-idle    { background: #1e2d3d; color: var(--dim);   border: 1px solid var(--border); }
  #nav-auto-btn.nav-active  { background: #0a1a0e; color: var(--green); border: 1px solid var(--green); box-shadow: 0 0 6px rgba(0,255,136,0.3); }

  /* Nav status panel */
  #nav-status-panel {
    display: none;
    background: #0d1a10;
    border-bottom: 1px solid #1e3d28;
    padding: 6px 10px;
    flex-shrink: 0;
  }
  #nav-status-panel.visible { display: block; }
  #nav-status-grid {
    display: grid; grid-template-columns: 1fr 1fr 1fr;
    gap: 3px 8px;
  }
  .nav-cell { display: flex; flex-direction: column; }
  .nav-cell-label { color: #5a8070; font-size: 9px; letter-spacing: 0.5px; }
  .nav-cell-val   { color: var(--text); font-size: 11px; }
  .nav-cell-val.green { color: var(--green); }

  /* AUTO MODE joystick overlay */
  #auto-overlay {
    display: none;
    position: absolute; inset: 0;
    background: rgba(0,0,0,0.7);
    align-items: center; justify-content: center;
    flex-direction: column; gap: 6px;
    z-index: 10;
    pointer-events: all;
    touch-action: none;
  }
  #auto-overlay.visible { display: flex; }
  #auto-overlay-text {
    color: var(--green); font-size: 16px; font-weight: bold;
    letter-spacing: 3px;
    text-shadow: 0 0 12px var(--green);
  }
  #auto-overlay-sub { color: var(--dim); font-size: 11px; letter-spacing: 1px; }

  /* Hidden file input */
  #csv-file-input { display: none; }
</style>
</head>
<body>

<div id="app">
  <!-- Title bar -->
  <div id="titlebar">
    <span class="title">FARM ROBOT</span>
    <span>
      <span id="status-dot"></span>
      <span id="status-text">OFFLINE</span>
    </span>
  </div>

  <!-- State toggle button -->
  <button id="state-btn" class="state-ready" disabled>
    <span id="state-indicator">‚óè</span>
    <span id="state-label">AUTO_READY ‚Äî TAP TO ACTIVATE</span>
  </button>

  <!-- HUD row (2√ó2 grid) -->
  <div id="hud-row">
    <!-- Accelerometer -->
    <div class="hud-panel">
      <div class="hud-panel-title">ACCELEROMETER</div>
      <div class="hud-value"><span class="hud-label">X</span><span class="hud-num" id="acc-x">-- m/s¬≤</span></div>
      <div class="hud-value"><span class="hud-label">Y</span><span class="hud-num" id="acc-y">-- m/s¬≤</span></div>
      <div class="hud-value"><span class="hud-label">Z</span><span class="hud-num" id="acc-z">-- m/s¬≤</span></div>
      <div style="margin-top:4px;" class="hud-panel-title">GYROSCOPE</div>
      <div class="hud-value"><span class="hud-label">X</span><span class="hud-num" id="gyro-x">-- rad/s</span></div>
      <div class="hud-value"><span class="hud-label">Y</span><span class="hud-num" id="gyro-y">-- rad/s</span></div>
      <div class="hud-value"><span class="hud-label">Z</span><span class="hud-num" id="gyro-z">-- rad/s</span></div>
    </div>

    <!-- Compass + Joystick data -->
    <div style="display:flex;flex-direction:column;gap:1px;background:var(--border);">
      <div id="compass-panel" class="hud-panel" style="flex:1;">
        <div class="hud-panel-title" style="align-self:stretch;">COMPASS</div>
        <div id="compass-svg-wrap">
          <svg id="compass-svg" viewBox="0 0 100 100">
            <!-- Outer ring -->
            <circle cx="50" cy="50" r="46" fill="none" stroke="#1e2d3d" stroke-width="2"/>
            <!-- Cardinal ticks -->
            <g stroke="#5a7080" stroke-width="1.5">
              <line x1="50" y1="6" x2="50" y2="14"/>
              <line x1="94" y1="50" x2="86" y2="50"/>
              <line x1="50" y1="94" x2="50" y2="86"/>
              <line x1="6" y1="50" x2="14" y2="50"/>
            </g>
            <!-- Cardinal labels -->
            <text x="50" y="22" text-anchor="middle" fill="#00d4ff" font-size="10" font-family="Courier New">N</text>
            <text x="50" y="84" text-anchor="middle" fill="#5a7080" font-size="9" font-family="Courier New">S</text>
            <text x="82" y="54" text-anchor="middle" fill="#5a7080" font-size="9" font-family="Courier New">E</text>
            <text x="18" y="54" text-anchor="middle" fill="#5a7080" font-size="9" font-family="Courier New">W</text>
            <!-- Needle group (rotated by JS) -->
            <g id="compass-needle" transform="rotate(0,50,50)">
              <!-- North (red) -->
              <polygon points="50,16 46,50 54,50" fill="#ff4060"/>
              <!-- South (dim) -->
              <polygon points="50,84 46,50 54,50" fill="#1e2d3d"/>
            </g>
            <!-- Center dot -->
            <circle cx="50" cy="50" r="3" fill="#00d4ff"/>
          </svg>
          <div id="compass-bearing">---¬∞</div>
          <div id="compass-cardinal">--</div>
          <div id="compass-accuracy" class="acc-0">‚óè UNCAL</div>
        </div>
      </div>

      <div id="joy-data-panel" class="hud-panel">
        <div class="hud-panel-title">JOYSTICK</div>
        <div class="hud-value"><span class="hud-label">Force</span><span class="hud-num accent" id="joy-force">0.00</span></div>
        <div class="hud-value"><span class="hud-label">Linear</span><span class="hud-num" id="joy-linear">+0.00 m/s</span></div>
        <div class="hud-value"><span class="hud-label">Angular</span><span class="hud-num" id="joy-angular">+0.00 r/s</span></div>
        <div class="hud-value"><span class="hud-label">Dir</span><span class="hud-num accent" id="joy-dir">--</span></div>
      </div>
    </div>
  </div>

  <!-- RTK GPS panel -->
  <div id="rtk-panel">
    <div id="rtk-header">
      <span id="rtk-title">RTK GPS</span>
      <span id="rtk-fix-badge">NO FIX</span>
      <span id="rtk-live-dot" title="RTK OFFLINE"></span>
    </div>
    <div id="rtk-grid">
      <div class="rtk-cell">
        <span class="rtk-cell-label">LAT</span>
        <span class="rtk-cell-val accent" id="rtk-lat">--</span>
      </div>
      <div class="rtk-cell">
        <span class="rtk-cell-label">LON</span>
        <span class="rtk-cell-val accent" id="rtk-lon">--</span>
      </div>
      <div class="rtk-cell">
        <span class="rtk-cell-label">ALT (m)</span>
        <span class="rtk-cell-val" id="rtk-alt">--</span>
      </div>
      <div class="rtk-cell">
        <span class="rtk-cell-label">SATS</span>
        <span class="rtk-cell-val" id="rtk-sats">--</span>
      </div>
      <div class="rtk-cell">
        <span class="rtk-cell-label">HDOP</span>
        <span class="rtk-cell-val" id="rtk-hdop">--</span>
      </div>
      <div class="rtk-cell">
        <span class="rtk-cell-label">SPD (kn)</span>
        <span class="rtk-cell-val" id="rtk-spd">--</span>
      </div>
    </div>
  </div>

  <!-- Record bar -->
  <div id="rec-bar">
    <button id="rec-btn" class="rec-idle">‚óè REC</button>
    <span id="rec-filename">‚Äî</span>
  </div>

  <!-- Navigation control panel -->
  <div id="nav-panel">
    <span id="nav-title">AUTO NAV</span>
    <input type="file" id="csv-file-input" accept=".csv,text/csv">
    <button id="nav-upload-btn">üìÇ UPLOAD CSV</button>
    <span id="nav-wp-count">0 WP</span>
    <button class="nav-mode-btn active" id="btn-p2p" title="ÁÇπÂØπÁÇπÁõ¥Êé•ÂØºËà™">P2P</button>
    <button class="nav-mode-btn" id="btn-pursuit" title="Pure Pursuit Ë∑ØÂæÑË∑üË∏™">PURSUIT</button>
    <button class="nav-mode-btn active" id="btn-mavg" title="ÁßªÂä®ÂùáÂÄº GPS Âπ≥Êªë">MOV-AVG</button>
    <button class="nav-mode-btn" id="btn-kalman" title="Âç°Â∞îÊõºÊª§Ê≥¢ GPS+IMU ËûçÂêà">KALMAN</button>
    <button id="nav-auto-btn" class="nav-idle">‚ñ∂ AUTO</button>
  </div>

  <!-- Navigation status panel (‰ªÖÂØºËà™‰∏≠ÊòæÁ§∫) -->
  <div id="nav-status-panel">
    <div id="nav-status-grid">
      <div class="nav-cell">
        <span class="nav-cell-label">PROGRESS</span>
        <span class="nav-cell-val green" id="nav-progress">‚Äî</span>
      </div>
      <div class="nav-cell">
        <span class="nav-cell-label">DISTANCE (m)</span>
        <span class="nav-cell-val" id="nav-dist">‚Äî</span>
      </div>
      <div class="nav-cell">
        <span class="nav-cell-label">BEARING (¬∞)</span>
        <span class="nav-cell-val" id="nav-bearing">‚Äî</span>
      </div>
      <div class="nav-cell">
        <span class="nav-cell-label">MODE</span>
        <span class="nav-cell-val" id="nav-mode-disp">‚Äî</span>
      </div>
      <div class="nav-cell">
        <span class="nav-cell-label">FILTER</span>
        <span class="nav-cell-val" id="nav-filter-disp">‚Äî</span>
      </div>
      <div class="nav-cell">
        <span class="nav-cell-label">TOLERANCE (m)</span>
        <span class="nav-cell-val" id="nav-tol">‚Äî</span>
      </div>
    </div>
  </div>

  <!-- Speed slider bar -->
  <div id="speed-bar">
    <span id="speed-label">SPEED</span>
    <input type="range" id="speed-slider" min="10" max="100" step="10" value="50">
    <span id="speed-value">50%</span>
  </div>

  <!-- Joystick zone -->
  <div id="joystick-zone">
    <span id="joystick-hint">TOUCH TO CONTROL</span>
    <div id="warn-banner">‚ö† CONNECTION LOST ‚Äî ROBOT STOPPED</div>
    <!-- AUTO MODE overlay -->
    <div id="auto-overlay">
      <div id="auto-overlay-text">AUTO MODE</div>
      <div id="auto-overlay-sub">JOYSTICK DISABLED</div>
    </div>
  </div>
</div>

<script src="/nipplejs.min.js"></script>
<script>
// ‚îÄ‚îÄ Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const WS_URL = `ws://${window.location.hostname}:8889/`;
const HEARTBEAT_INTERVAL_MS = 500;
const JOYSTICK_SEND_INTERVAL_MS = 100;  // 10Hz throttle
const DEADZONE = 0.15;

// MAX_LINEAR_VEL / MAX_ANGULAR_VEL are injected by the server
// as meta tags or we read them from a global set by SSE/query param.
// Fallback: 1.0
const MAX_LINEAR  = parseFloat(document.documentElement.dataset.maxLinear  || "1.0");
const MAX_ANGULAR = parseFloat(document.documentElement.dataset.maxAngular || "1.0");

// ‚îÄ‚îÄ Speed ratio (ÂâçÁ´ØÁº©ÊîæÔºåÈªòËÆ§50%) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let speedRatio = 0.5;

// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let ws = null;
let joystickActive = false;
let currentLinear  = 0.0;
let currentAngular = 0.0;
let currentForce   = 0.0;
let heartbeatTimer = null;
let joySendTimer   = null;
let lastHeartbeatSent = 0;

// ‚îÄ‚îÄ State machine (client-side tracking) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let controlStateActive = false;  // false = AUTO_READY, true = AUTO_ACTIVE

// ‚îÄ‚îÄ Navigation state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let navActive   = false;      // true when server reports state=navigating
let navWpCount  = 0;          // Â∑≤‰∏ä‰º†Ëà™ÁÇπÊï∞
let navMode     = "p2p";      // p2p | pure_pursuit
let filterMode  = "moving_avg"; // moving_avg | kalman

function toggleControlState() {
  sendMsg({ type: "toggle_state" });
  // ‰∏çÂÜçÁ´ãÂç≥ÁøªËΩ¨Áä∂ÊÄÅÔºåÁ≠âÊúçÂä°Á´Ø state_status Á°ÆËÆ§ÔºåÈò≤Ê≠¢ËøûÁª≠ÁÇπÂáªÂèëÂ§öÊ¨°Êåá‰ª§
  document.getElementById('state-btn').disabled = true;
}

function updateStateBtn() {
  const btn = document.getElementById('state-btn');
  const lbl = document.getElementById('state-label');
  if (controlStateActive) {
    btn.className = 'state-active';
    lbl.textContent = 'AUTO_ACTIVE ‚Äî TAP TO DEACTIVATE';
  } else {
    btn.className = 'state-ready';
    lbl.textContent = 'AUTO_READY ‚Äî TAP TO ACTIVATE';
  }
}

// ‚îÄ‚îÄ WebSocket ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function connect() {
  ws = new WebSocket(WS_URL);

  ws.onopen = () => {
    setStatus(true);
    scheduleHeartbeat();
    scheduleJoySend();
  };

  ws.onclose = () => {
    setStatus(false);
    clearTimers();
    // Auto-reconnect after 2s
    setTimeout(connect, 2000);
  };

  ws.onerror = () => {
    ws.close();
  };

  ws.onmessage = (evt) => {
    try {
      const msg = JSON.parse(evt.data);
      if (msg.type === "imu")            handleIMU(msg);
      if (msg.type === "status")         handleStatus(msg);
      if (msg.type === "rtk")            handleRTK(msg);
      if (msg.type === "record_status")  handleRecordStatus(msg);
      if (msg.type === "state_status")   handleStateStatus(msg);
      if (msg.type === "waypoints_loaded") handleWaypointsLoaded(msg);
      if (msg.type === "nav_status")     handleNavStatus(msg);
      if (msg.type === "nav_complete")   handleNavComplete(msg);
      if (msg.type === "nav_warning")    handleNavWarning(msg);
    } catch(e) {}
  };
}

function sendMsg(obj) {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify(obj));
  }
}

// ‚îÄ‚îÄ Timers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function scheduleHeartbeat() {
  heartbeatTimer = setInterval(() => {
    sendMsg({ type: "heartbeat" });
  }, HEARTBEAT_INTERVAL_MS);
}

function scheduleJoySend() {
  joySendTimer = setInterval(() => {
    if (joystickActive && !navActive) {
      sendMsg({ type: "joystick", linear: currentLinear, angular: currentAngular, force: currentForce });
    }
  }, JOYSTICK_SEND_INTERVAL_MS);
}

function clearTimers() {
  if (heartbeatTimer) { clearInterval(heartbeatTimer); heartbeatTimer = null; }
  if (joySendTimer)   { clearInterval(joySendTimer);   joySendTimer   = null; }
}

// ‚îÄ‚îÄ Status UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setStatus(online) {
  const dot  = document.getElementById('status-dot');
  const text = document.getElementById('status-text');
  const warn = document.getElementById('warn-banner');
  const btn  = document.getElementById('state-btn');
  if (online) {
    dot.className = 'online';
    text.textContent = 'ONLINE';
    warn.classList.remove('visible');
    btn.disabled = false;
  } else {
    dot.className = 'offline';
    text.textContent = 'OFFLINE';
    warn.classList.add('visible');
    btn.disabled = true;
    // Êñ≠Á∫øÂêé‰øùÊåÅÊúÄÂêéÂ∑≤Áü•Áä∂ÊÄÅÔºåÈáçËøûÂêéÁî±ÊúçÂä°Á´ØÊé®ÈÄÅ state_status ÂêåÊ≠•
  }
}

// ‚îÄ‚îÄ IMU HUD update ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmt3(v) { return (v >= 0 ? '+' : '') + v.toFixed(3); }
function fmt2(v) { return (v >= 0 ? '+' : '') + v.toFixed(2); }

function handleIMU(msg) {
  if (msg.accel) {
    document.getElementById('acc-x').textContent = fmt3(msg.accel.x) + ' m/s¬≤';
    document.getElementById('acc-y').textContent = fmt3(msg.accel.y) + ' m/s¬≤';
    document.getElementById('acc-z').textContent = fmt3(msg.accel.z) + ' m/s¬≤';
  }
  if (msg.gyro) {
    document.getElementById('gyro-x').textContent = fmt3(msg.gyro.x) + ' r/s';
    document.getElementById('gyro-y').textContent = fmt3(msg.gyro.y) + ' r/s';
    document.getElementById('gyro-z').textContent = fmt3(msg.gyro.z) + ' r/s';
  }
  if (msg.compass) {
    const c = msg.compass;
    const needle = document.getElementById('compass-needle');
    needle.setAttribute('transform', `rotate(${c.bearing.toFixed(1)},50,50)`);
    document.getElementById('compass-bearing').textContent = c.bearing.toFixed(1) + '¬∞';
    document.getElementById('compass-cardinal').textContent = c.cardinal;
    const acc = (c.accuracy !== undefined) ? Math.min(Math.max(c.accuracy, 0), 3) : (c.calibrated ? 3 : 0);
    const accLabels = ['‚óè UNCAL', '‚óè LOW', '‚óè GOOD', '‚óè PRECISE'];
    const accEl = document.getElementById('compass-accuracy');
    accEl.textContent = accLabels[acc];
    accEl.className = `acc-${acc}`;
  }
}

function handleStatus(msg) {
  // Could show serial/imu status if needed
}

// ‚îÄ‚îÄ RTK HUD update ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FIX_LABELS = {
  0: { text: "NO FIX",   cls: "" },
  1: { text: "GPS",      cls: "fix-gps" },
  2: { text: "DGPS",     cls: "fix-gps" },
  4: { text: "RTK FIX",  cls: "fix-rtk" },
  5: { text: "RTK FLT",  cls: "fix-gps" },
};

function handleRTK(msg) {
  const dot   = document.getElementById('rtk-live-dot');
  const badge = document.getElementById('rtk-fix-badge');

  if (!msg.available) {
    dot.className = '';
    dot.title = 'RTK OFFLINE';
    badge.textContent = 'OFFLINE';
    badge.className = '';
    return;
  }

  dot.className = 'live';
  dot.title = 'RTK LIVE';

  const fq = msg.fix_quality || 0;
  const fi = FIX_LABELS[fq] || { text: `FIX(${fq})`, cls: "fix-gps" };
  badge.textContent = fi.text;
  badge.className = fi.cls;

  const fmtCoord = (v, d) => (v !== null && v !== undefined) ? v.toFixed(d) : '--';
  document.getElementById('rtk-lat').textContent  = fmtCoord(msg.lat, 7);
  document.getElementById('rtk-lon').textContent  = fmtCoord(msg.lon, 7);
  document.getElementById('rtk-alt').textContent  = fmtCoord(msg.alt, 2);
  document.getElementById('rtk-sats').textContent = (msg.num_sats !== null && msg.num_sats !== undefined) ? msg.num_sats : '--';
  document.getElementById('rtk-hdop').textContent = fmtCoord(msg.hdop, 2);
  document.getElementById('rtk-spd').textContent  = fmtCoord(msg.speed_knots, 2);
}

// ‚îÄ‚îÄ State status update ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleStateStatus(msg) {
  controlStateActive = msg.active;
  updateStateBtn();
  document.getElementById('state-btn').disabled = false;  // Ëß£Èô§ÊåâÈíÆÁ¶ÅÁî®
}

// ‚îÄ‚îÄ Record status update ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleRecordStatus(msg) {
  const btn      = document.getElementById('rec-btn');
  const fnSpan   = document.getElementById('rec-filename');
  if (msg.recording) {
    btn.className = 'rec-active';
    btn.textContent = '‚ñ† STOP';
    fnSpan.textContent = msg.filename || '‚Äî';
  } else {
    btn.className = 'rec-idle';
    btn.textContent = '‚óè REC';
    fnSpan.textContent = '‚Äî';
  }
}

// ‚îÄ‚îÄ Navigation handlers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleWaypointsLoaded(msg) {
  navWpCount = msg.count || 0;
  document.getElementById('nav-wp-count').textContent = navWpCount + ' WP';
  if (msg.error) {
    document.getElementById('nav-wp-count').style.color = 'var(--red)';
  } else {
    document.getElementById('nav-wp-count').style.color = navWpCount > 0 ? 'var(--green)' : 'var(--dim)';
  }
}

function handleNavStatus(msg) {
  const state = msg.state || 'idle';
  navActive = (state === 'navigating');

  // ÂØºËà™Áä∂ÊÄÅÈù¢ÊùøÊòæÁ§∫/ÈöêËóè
  const statusPanel = document.getElementById('nav-status-panel');
  if (navActive || state === 'finished') {
    statusPanel.classList.add('visible');
  } else {
    statusPanel.classList.remove('visible');
  }

  // AUTO ÊåâÈíÆÁä∂ÊÄÅ
  const autoBtn = document.getElementById('nav-auto-btn');
  if (navActive) {
    autoBtn.className = 'nav-active';
    autoBtn.textContent = '‚ñ† STOP';
  } else {
    autoBtn.className = 'nav-idle';
    autoBtn.textContent = '‚ñ∂ AUTO';
  }

  // AUTO MODE ÈÅÆÁΩ©
  const overlay = document.getElementById('auto-overlay');
  if (navActive) {
    overlay.classList.add('visible');
  } else {
    overlay.classList.remove('visible');
  }

  // Áä∂ÊÄÅÈù¢ÊùøÊï∞ÂÄºÊõ¥Êñ∞
  const prog = msg.progress || [0, 0];
  document.getElementById('nav-progress').textContent  = prog[0] + ' / ' + prog[1];
  document.getElementById('nav-dist').textContent     = msg.distance_m !== null && msg.distance_m !== undefined ? msg.distance_m.toFixed(1) : '--';
  document.getElementById('nav-bearing').textContent  = msg.target_bearing !== null && msg.target_bearing !== undefined ? msg.target_bearing.toFixed(0) + '¬∞' : '--';
  document.getElementById('nav-mode-disp').textContent   = (msg.nav_mode || '--').toUpperCase();
  document.getElementById('nav-filter-disp').textContent = (msg.filter_mode || '--').toUpperCase();
  document.getElementById('nav-tol').textContent     = msg.tolerance_m !== null && msg.tolerance_m !== undefined ? msg.tolerance_m.toFixed(1) : '--';
}

function handleNavComplete(msg) {
  navActive = false;
  document.getElementById('auto-overlay').classList.remove('visible');
  document.getElementById('nav-auto-btn').className = 'nav-idle';
  document.getElementById('nav-auto-btn').textContent = '‚ñ∂ AUTO';
  const total = msg.total_wp || 0;
  // Âú®Áä∂ÊÄÅÈù¢ÊùøÊòæÁ§∫ÂÆåÊàê‰ø°ÊÅØ
  document.getElementById('nav-progress').textContent = '‚úì DONE (' + total + ')';
  document.getElementById('nav-status-panel').classList.add('visible');
}

function handleNavWarning(msg) {
  const warn = document.getElementById('warn-banner');
  const txt = msg.msg || 'Navigation warning';
  warn.textContent = '‚ö† ' + txt.toUpperCase();
  warn.classList.add('visible');
  setTimeout(() => {
    if (!ws || ws.readyState !== WebSocket.OPEN) return;
    warn.classList.remove('visible');
    warn.textContent = '‚ö† CONNECTION LOST ‚Äî ROBOT STOPPED';
  }, 5000);
}

// ‚îÄ‚îÄ Nav mode & filter toggle helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setNavMode(mode) {
  navMode = mode;
  document.getElementById('btn-p2p').classList.toggle('active',     mode === 'p2p');
  document.getElementById('btn-pursuit').classList.toggle('active', mode === 'pure_pursuit');
  sendMsg({ type: 'nav_mode', mode: mode });
}

function setFilterMode(mode) {
  filterMode = mode;
  document.getElementById('btn-mavg').classList.toggle('active',   mode === 'moving_avg');
  document.getElementById('btn-kalman').classList.toggle('active', mode === 'kalman');
  sendMsg({ type: 'filter_mode', mode: mode });
}

// ‚îÄ‚îÄ Direction label ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function dirLabel(linear, angular) {
  const fwd  = linear  >  0.05;
  const back = linear  < -0.05;
  const left = angular >  0.05;
  const right= angular < -0.05;
  if (!fwd && !back && !left && !right) return '‚ñ† STOP';
  let s = '';
  if (fwd)  s += '‚Üë';
  if (back) s += '‚Üì';
  if (left) s += '‚Üê';
  if (right)s += '‚Üí';
  return s;
}

// ‚îÄ‚îÄ Joystick update ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateJoyUI() {
  document.getElementById('joy-force').textContent   = currentForce.toFixed(2);
  document.getElementById('joy-linear').textContent  = fmt2(currentLinear)  + ' m/s';
  document.getElementById('joy-angular').textContent = fmt2(currentAngular) + ' r/s';
  document.getElementById('joy-dir').textContent     = dirLabel(currentLinear, currentAngular);
}

// ‚îÄ‚îÄ nipplejs setup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('load', () => {
  const zone = document.getElementById('joystick-zone');
  const hint = document.getElementById('joystick-hint');

  const manager = nipplejs.create({
    zone: zone,
    mode: 'static',
    position: { left: '50%', top: '50%' },
    size: 160,
    color: '#00d4ff',
    restOpacity: 0.6,
  });

  manager.on('start', () => {
    joystickActive = true;
    hint.style.display = 'none';
  });

  manager.on('move', (evt, data) => {
    const force = Math.min(data.force, 1.0);
    // nipplejs: angle in degrees, 0=right, 90=up (CCW)
    const angleRad = data.angle.radian;
    let rawX = Math.cos(angleRad) * force;  // right positive
    let rawY = Math.sin(angleRad) * force;  // up positive

    if (force < DEADZONE) {
      currentLinear  = 0.0;
      currentAngular = 0.0;
      currentForce   = 0.0;
    } else {
      currentLinear  =  rawY * MAX_LINEAR  * speedRatio;   // up ‚Üí forward
      currentAngular = -rawX * MAX_ANGULAR * speedRatio;   // right ‚Üí negative angular (Amiga convention)
      currentForce   = force;
    }
    updateJoyUI();
  });

  manager.on('end', () => {
    joystickActive = false;
    currentLinear  = 0.0;
    currentAngular = 0.0;
    currentForce   = 0.0;
    updateJoyUI();
    // Immediate stop
    sendMsg({ type: "joystick", linear: 0.0, angular: 0.0, force: 0.0 });
    hint.style.display = 'block';
  });

  // State toggle button bindings
  const stateBtn = document.getElementById('state-btn');
  stateBtn.addEventListener('click', toggleControlState);
  // Ëß¶Êë∏ËÆæÂ§áÈò≤ÂèåËß¶
  stateBtn.addEventListener('touchend', (e) => {
    e.preventDefault();
    toggleControlState();
  });

  // Record button bindings
  const recBtn = document.getElementById('rec-btn');
  recBtn.addEventListener('click', () => {
    sendMsg({ type: "toggle_record" });
  });
  recBtn.addEventListener('touchend', (e) => {
    e.preventDefault();
    sendMsg({ type: "toggle_record" });
  });

  // Speed slider bindings
  const speedSlider = document.getElementById('speed-slider');
  speedSlider.addEventListener('input', (e) => {
    speedRatio = parseInt(e.target.value) / 100;
    document.getElementById('speed-value').textContent = e.target.value + '%';
  });

  // ‚îÄ‚îÄ Navigation bindings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // CSV upload
  const csvInput = document.getElementById('csv-file-input');
  const uploadBtn = document.getElementById('nav-upload-btn');
  uploadBtn.addEventListener('click', () => csvInput.click());
  uploadBtn.addEventListener('touchend', (e) => { e.preventDefault(); csvInput.click(); });
  csvInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      const csv = ev.target.result;
      sendMsg({ type: 'upload_waypoints', csv: csv });
    };
    reader.readAsText(file);
    // ÈáçÁΩÆ input ‰ª•‰æøÈáçÂ§çÈÄâÂêå‰∏ÄÊñá‰ª∂
    csvInput.value = '';
  });

  // Nav mode buttons
  document.getElementById('btn-p2p').addEventListener('click',     () => setNavMode('p2p'));
  document.getElementById('btn-pursuit').addEventListener('click', () => setNavMode('pure_pursuit'));
  document.getElementById('btn-mavg').addEventListener('click',   () => setFilterMode('moving_avg'));
  document.getElementById('btn-kalman').addEventListener('click',  () => setFilterMode('kalman'));

  // AUTO start/stop button
  const autoBtn = document.getElementById('nav-auto-btn');
  function toggleNav() {
    if (navActive) {
      sendMsg({ type: 'nav_stop' });
    } else {
      sendMsg({ type: 'nav_start' });
    }
  }
  autoBtn.addEventListener('click', toggleNav);
  autoBtn.addEventListener('touchend', (e) => { e.preventDefault(); toggleNav(); });

  // Start WebSocket
  connect();
});
</script>
</body>
</html>
